# A simple action usage
name: Missionary-Zeta GKI
on:
  workflow_dispatch:

jobs:
  Build-Kernel:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build info
        run: |
          echo "--------------------------------------------------"
          echo "Using standalone AOSP Clang: r522817 (Clang 21)"
          echo "AOSP GCC and action-managed AOSP Clang disabled"
          echo "--------------------------------------------------"

      - name: Install standalone Clang (r522817)
        run: |
          set -euo pipefail
          mkdir -p /opt/clang
          curl -fsSL https://storage.googleapis.com/android-clang/clang-r522817-linux-x86.tar.gz \
            -o /tmp/clang.tar.gz
          tar -xzf /tmp/clang.tar.gz -C /opt/clang --strip-components=1
          echo "/opt/clang/bin" >> $GITHUB_PATH
          chmod -R a+rX /opt/clang

      - name: Zeta âœ¦ Build
        uses: dabao1955/kernel_build_action@main
        with:
          # ðŸ”´ IMPORTANT: this repo MUST contain branch "rama"
          kernel-url: https://github.com/ramabondanp/android_kernel_common-5.10.git   
kernel-dir: common
          kernel-branch: android12-5.10

          config: gki_defconfig
          arch: arm64
          android-version: 15

          aosp-gcc: false
          aosp-clang: false
          aosp-clang-version: r522817

          ksu: true
          ksu-version: master
          ksu-other: true
          ksu-url: https://github.com/RapliVx/KernelSU

          disable-lto: false

          extra-make-args: |
            LLVM=1
            LLVM_IAS=1
            CONFIG_LOCALVERSION=âœ¦-Missionary-Zeta
            CONFIG_LTO_CLANG_FULL=y
            CONFIG_KSU_SYSCALL_HOOK=y
            CONFIG_KPROBES=y
            CONFIG_KRETPROBES=y
            CONFIG_HAVE_SYSCALL_TRACEPOINTS=y
            CONFIG_PREEMPT=y
            CONFIG_PREEMPTION=y
            CONFIG_PREEMPT_COUNT=y
            CONFIG_HZ=250
            CONFIG_TCP_CONG_BBRPLUS=y
            CONFIG_DEFAULT_TCP_CONG=bbrplus
            CONFIG_ZRAM_STREAMS=y
            CONFIG_ZRAM_DEF_COMP_THREADS=4
            CONFIG_WQ_POWER_EFFICIENT_DEFAULT=y
            CONFIG_SCHED_AUTOGROUP=y
            CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
            CONFIG_CPU_IDLE_GOV_TEO=y
            CONFIG_RCU_BOOST=y
            CONFIG_SLUB_DEBUG=n
            CONFIG_OPTIMIZE_INLINING=y
            CONFIG_VDSO=y
            CONFIG_DISABLE_UNUSED_SYMBOLS=y
            CONFIG_PANIC_TIMEOUT=0
            KCFLAGS=-Wno-error
            CONFIG_ENERGY_MODEL=y
            CONFIG_CPU_IDLE_GOV_MENU=n
            CONFIG_ARM_PSCI_CPUIDLE=y
            CONFIG_TICK_ONESHOT=y
            CONFIG_NO_HZ_FULL=y
            CONFIG_SCHED_MC=y
            CONFIG_PM_AUTOSLEEP=y
            CONFIG_PM_WAKELOCKS_LIMIT=0
            CONFIG_SCHED_HRTICK=y
            CONFIG_UCLAMP_TASK=y
            CONFIG_CRYPTO_LZ4=y

          anykernel3: true
